---
layout: post
title: "Windows默认共享与加固建议"
category: 等级保护
tags: [Windows, "Security Harden", “Default Share”]
---

##一 概述

默认共享是系统安装完毕后就自动开启的共享，也叫管理共享，常被管理员用于远程管理计算机。在Windows 2000/XP及其以上版本中，默认开启的共享有“c$”、“d$”、“admin$”、“ipc$”等，我们可以在“运行”对话框中输入“\\计算机名\盘符$”对这些资源进行访问，以上这些共享就叫做默认共享。微软的初衷是便于网管进行远程管理。默认共享是管理员级别或是有相对应权限的账户的操作。

其中，IPC$是最为臭名昭著的默认共享，起初是为了让进程间通信而开放的命名管道，可以通过验证账户和口令来获得相应权限，从而实现远程管理计算机和查看计算机的共享资源。利用IP$，攻击者可以无需输入账户和口令，便可以与目标系统建立一个空连接，得到目标系统的用户列表。进而利用获得的用户列表发动暴力破解或字典攻击，获得目标系统的权限。


##二 与普通共享区别

1. 管理员组专用共享：  默认共享是只面向管理员组用户开启的共享，也就是说只有管理员组的用户才能访问这些共享，非管理员组用户(即使是超级用户)不能进行访问。
2. 隐蔽性：  默认共享是由系统自动创建的，无法通过“网上邻居”查看到这些共享资源，这也是默认共享和手动创建的共享目录的区别。唯一的方法就是通过UNC路径来实现访问。所谓UNC路径实际上就是在“特权一”中提到的“\\计算机名\盘符$”形式的路径(例如\\softer\c$)。
3.  关闭方法“特殊”：手动关闭普通共享目录，只要右键点击已经共享的目录，然后选择“共享和安全”，在弹出的对话框中选择“不共享该文件夹”即可。然而默认共享的关闭就要复杂得多，而且如果设置不正确，重新启动计算机后这些默认共享又会自动打开。


##三 经典入侵方式

在获得目标系统的账户和口令前提之下：

1. 与目标主机IPC$建立连接

		net use \\目标IP\IPC$ "密码" /user:"账户"

2. 上传可执行程序

		copy hack.exe \\目标IP\C$

3. 获取目标主机系统时间

		net time \\目标IP

4. 通过任务计划执行可执行程序

		at \\目标IP 时间 hack.exe

5. 删除共享映射

	net use * /del /y  删除全部
	net use c: /del 

##四 关闭默认共享方法

如果不需要使用Windows共享，可以通过关闭共享来降低安全风险。

###1. 图形界面方式：

通过"控制面板"->"管理工具"->"计算机管理"->"系统工具"->"共享"，即可对默认共享ipc$、ADMIN$等进行删除。

###2. 命令行方式：

当不想改动注册表，或只是临时删除这些共享时，可以使用 net share 命令：
	
	net share admin$ /delete
	net share ipc$ /delete
	net share c$ /delete
	net share d$ /delete

若要每次开机后自动删除默认共享，仅需把命令保存为.bat文件，开机自动运行就便可以了。

###3. 注册表方式：

可以从根本上解决系统自动启动默认共享的问题，但是需要重新启动计算机。
	
1. 关闭分区默认共享(如C$、D$、E$ 等)

	展开注册表项：

	`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Lanmanserver\parameters`

	把**AutoShareServer**设置为**0**即可。

2. 关闭管理默认共享(ADMIN$)

	展开注册表项：
	
	`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Lanmanserver\parameters`

	把**AutoShareWks**键值设置为**0**即可。

3. 关闭IPC$默认共享

	展开注册表项：

	`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa`
	
	把**restrictanonymous**键值设置为**1**即可。

	= DWORD的键值改为：1
	
	如果设置为"1"，匿名用户仍然可以连接到IPC$共享，但无法通过这种连接得到列举SAM帐号和共享信息的权限；在Windows 2000 中增加了"2"，未取得匿名权的用户将不能进行ipc$空连接。建议设置为1。如果你觉得改注册表麻烦，可以在本地安全设置中设置此项： 在本地安全设置－本地策略－安全选项－'对匿名连接的额外限制'

###	4. 停止服务方式

通过"控制面板"->"管理工具"->"计算机管理"->"服务"->禁用“Server”服务即可。通过命令行：

	net stop lanmanserver

###5. 卸载共享功能

设置方法简单，杜绝了共享访问漏洞。缺点是：1.卸载之后，无法再共享文件夹。2. 若存在多个网卡，需对每个网卡进行卸载。

通过"控制面板"->“网络连接”->"本地连接"->"属性"->"Microsoft 网络的文件和打印机共享"->"卸载"即可。

##加强共享安全的组策略

若需要使用Windows共享服务时，需要使用以下组策略加强其安全性，比如：

1. 关闭SAM账号和共享的匿名枚举

	运行**gpedit.msc**，依次展开：“计算机配置”->“Windows设置”->“安全设置”->“本地策略”->“安全选项”，启用“**网络访问:不允许SAM账号和共享的匿名枚举**”。
2. 禁止非授权访问：白名单和黑名单
	
	运行**gpedit.msc**，依次展开：“计算机配置”->“Windows设置”->“安全设置”->“本地策略”->“用户权限分配”，把需要访问共享的账户添加到“**从网络访问此计算机**”，把禁止访问共享账户加入“**拒绝从网络访问这台计算机**”。
3. 禁止匿名SID/名称转换：禁止使用SID获取账户名

	运行**gpedit.msc**，依次展开：“计算机配置”->“Windows设置”->“安全设置”->“本地策略”->“安全选项”，禁用“**网络访问：允许匿名SID/名称转换**”。

4. 审计访问共享的操作：

	右击目标文件夹，依次展开：”属性“->”安全“->”高级“->”审核“->”添加“。然后”主体“选择
##五 后记

实际上默认共享只在某些情况下用到，关闭默认共享并不会影响上网聊天、收发邮件等普通操作，不过对于域控制器或网络中使用了C/S类型的软件等环境来说，盲目删除默认共享带来的危害是巨大的。

参考连接：

1. [默认共享管理](http://dada89007.iteye.com/blog/919916)
2. [详尽的IPC入侵教程](http://wenku.baidu.com/link?url=jzC200nrKDqUZyOx41wTUoFxCkRyvg5cXF_dVKmMdI4CGgIWEKP__ZEkiRHxwf62aDueQ5ZOsvGmgqpflleuVRKCehAWM0UfFAtBstyVeNC)
3. [Windows组策略管理网络共享](http://os.yesky.com/win/273/2687273.shtml)