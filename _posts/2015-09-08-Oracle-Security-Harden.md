---
layout: post
title:  "Oracle 安全加固-1. Oracle网络配置及加固建议 "
date:   2015-09-04 22:11:00
category: Oracle
tags: [Oracle, Security]
---
* content
{:toc}

连接到Oracle数据库常见的命令形式有：

1.  `sqlplus / as sysdba` : 典型操作系统认证，连接到Oracle本地数据库，不需要监听进程。
2.  `sqlplus sys/oracle` : 只能连接到Oracle本地数据库，同样不需要监听进程。
3.  `sqlplus sys/oracle@orcl`：网络连接Oracle数据库，可以本地/远程数据库，需要监听进程处于可用状态。

接下来着重介绍网络登录Oracle数据库的相关配置文件以及安全加固方法。

##1. 配置文件##

Oracle网络配置涉及sqlnet.ora、tnsnames.ora、listener.ora三个文件。其中listener.ora是与数据库服务器端相关；而tnsnames.ora和sqlnet.ora不仅仅关系到服务器端，主要还是和客户端关系密切。

### 1.1 sqlnet.ora###

sqlnet.ora 用在oracle 客户端，配置连接Oracle数据库服务器的相关参数。

相关参数：

- SQLNET.AUTHENTICATION_SERVICES：身份认证方式
	
	
	取值：

	+ NONE：Oracle数据库身份验证，如在数据库服务器上输入`conn sys/password@oracle as sysdba`才可登录。
	+ NTS：操作系统身份验证，即OS认证，例如在数据库服务器上输入`conn / as sysdba`便可登录。
	+ ALL：两者均可。

	默认值：NONE
	
	说明：
	
	1. 在Windows系统上，必须设置为NTS或者 ALL才能使用OS认证；不设置或者设置为NONE都不能使用OS认证。
	
	2. 在Linux系统上，设置为ALL或者不设置的情况下，OS认证才能成功；设置为其他任何值都不能使用OS认证。

- NAMES.DIRECTORY_PATH：客户端连接参数解析顺序

	假设NAMES.DIRECTORY_PATH=(tnsnames, hostname, Ezconnect)。我们在客户端输入`sqlplus sys/oracle@orcl `，客户端首先会从tnsnames.ora查找要连接的字符串（如orcl）记录；若tnsname.ora文件中无此记录，客户端尝试把要连接的字符串（如orcl）当作一个主机名，通过网络的途径去解析其ip地址，然后再连接此ip上GLOBAL_DBNAME=连接字符串（如orcl）这个实例，当然这里连接字符串（如orcl）并不是一个主机名，最后会尝试以ezconnect的方式连接数据库。

	取值区间：

	+ tnsnames
	+ hostname 
	+ onames
	+ onames
	+ cds
 	+ nis
	+ Ezconnect
	
	默认值：(tnsnames, onames, hostname)
- TCP.VALIDNODE_CHECKING：启动/关闭**Oracle Net Valid Node Checking（网络合法节点检查）**，轻量级的访问控制策略来控制监听器允许或者拒绝某些IP访问Oracle数据库，从8i起开始提供这个功能，**只需在Oracle服务器端配置**。
- TCP.EXCLUDED_NODES：指定哪些客户端不允许通过TCP/IP协议访问数据库，可以通过reload生效。
- TCP.INVITED_NODES：指定哪些客户端允许通过TCP/IP协议访问数据库，可以通过reload生效。只两个参数从11g起支持通配符如172.1.2.*。

**Oracle Net Valid Node Checking（网络合法节点检查）**

1. tcp.invited_nodes和tcp.excluded_nodes存在冲突时，以tcp.invited_nodes 为主。
2. 每次修改后要重启监听。
3. 数据库服务器的ip也要加入 tcp.invited_nodes。


### 1.2 tnsnames.ora###

tnsnames.ora 一般用于Oracle客户端，配置连接数据库的连接信息，提供tnsname别名到主机名或者ip的映射，类似系统中的hosts文件一样。仅当sqlnet.ora中NAMES.DIRECTORY_PATH参数包含 TNSNAMES才会生效，也就是客户端解析连接字符串的顺序包含了TNSNAMES，客户端才会尝试使用该文件。

如果是客户机/服务器结构，整个网络上只有一台机器安装了ORACLE数据库服务器，那么只需在每个要访问ORACLE服务器的客户机上定义该文件，在服务器上无需定义。但是，如果网络上有多台机器均安装了ORACLE数据库服务器，并且服务器之间有数据共享的要求，那么在每台服务器上都必须定义该文件。

一个示例tnsnames.ora配置文件如下：

	# tnsnames.ora Network Configuration File: E:\oracle\product\10.2.0\db_1\network\admin\tnsnames.ora
	# Generated by Oracle configuration tools.
	SERVER213 =
	(DESCRIPTION =
	    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.1.213)(PORT = 1521))
	    (CONNECT_DATA =
	      (SERVER = DEDICATED)
	      (SERVICE_NAME = orcl)
	    )
	  )

其中各个字段含义如下：

- SERVER213：客户端定义和使用的数据库服务器的别名，可以任意取，不必和服务器一样，在客户端使用此别名即可连接到数据库服务器，如`CONNECT username/password@SERVER213`。
- ADDRESS_LIST：表示该客户机要经由多种协议与一台或多台服务器连接。在该样式文件中就表示该客户机要用TCP/IP协议来和服务器相连。
- PROTOCOL：指明要连接使用的协议。
- HOST：TCP/IP协议使用的服务器IP地址。
- PORT：TCP/IP使用的端口地址。
- SERVICE_NAME：Oracle数据库服务器的服务名，必须和数据库服务器`;show parameter service_name;`输出一致。
- SID：指定要连接的服务器上ORACLE数据库的ORACLE_SID。
- SERVER：数据库连接方式，SHARED或DEDICATED ，DEDICATED 是专有连接方式，SHARED是共享连接方式。区别在于专有连接方式是一个用户对应一个数据库服务器进程，而共享服务器连接方式是多个用户可以不定向轮流使用一个服务器进程。可以通过`show parameter shared_servers;`判断数据库服务器的连接模式，其中**0**表示**专有连接方式**，**1**表示**共享连接方式**。

###1.3 listener.ora###

tnslsnr进程是监听、并接受远程连接数据库请求的监听进程，listener.ora是tnslsnr进程的配置文件，监听的参数都是从该配置文件中读取。如果你只需要在本地连接数据库，不接受远程连接，那么也不需要启动tnslsnr进程，也不需要去维护listener.ora文件。

使用命令`lsnrctl`加上参数`start/stop/status`来执行启动Oracle监听器、关闭Oracle监听器和查看Oracle监听器的状态。

###1.4 小结###
上述三个配置文件均可以通过GUI配置工具来完成配置，如netca、netmgr。其中netca是以向导模式进行配置的，图形化界面比较简洁，建议初学者使用。其中netmgr比较常用，配置界面如下图所示。
![netmgr]({{ "/css/pics/Oracle/Oracle_net_cfg.PNG"}})  

##2. 客户端登录数据库服务器##

当你输入sqlplus sys/oracle@orcl，具体的登录步骤如下：

1. 查询sqlnet.ora名称的解析方式，发现是TNSNAME 。
2. 从tnsnames.ora文件查询orcl的记录，并解析得到主机名或IP、端口及service_name。
3. 尝试与数据库服务器的listener进程建立连接。   
4. 依据不同的服务器模式，如专用服务器模式或者共享服务器模式，listener采取接下去的动作。默认是专用服务器模式，没有问题的话客户端就连接上了数据库的server process。

参考链接：

1. [聊聊Oracle的OS验证登录](http://blog.itpub.net/17203031/viewspace-1218732 "聊聊Oracle的OS验证登录 ")
2. [监听器listener.ora中HOST参数配置](http://blog.itpub.net/17203031/viewspace-1066563/ "监听器listener.ora中HOST参数配置")
3. [Oracle网络配置用到的sqlnet.ora,tnsnames.ora,listener.ora](http://blog.chinaunix.net/uid-44616-id-2120923.html "Oracle网络配置用到的sqlnet.ora,tnsnames.ora,listener.ora ")
4. [Oracle Database Advanced Security Administrator's Guide](http://docs.oracle.com/cd/B19306_01/network.102/b14268/toc.htm "Oracle Database Advanced Security Administrator's Guide")